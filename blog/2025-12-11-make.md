---
slug: Make
title: How To Write a Good Makefile
authors: [zephyr]
tags: [nemu]
---

## Variable

Make can read Variables from the [Environment](https://stackoverflow.com/questions/39036774/advanced-variable-inheritance-in-gnu-make)
define Variables `SRC = main.c utils.c` then use `$(SRC)` rather than `$SRC`.
Only the single alphabet variables can use `$S` without `()`

**addons**  use `SRC += extra.c`

Commonly used auto variables:

| code | meaning|
|--|--|
| `$@` | current target|
| `$<` | current first dependency|
| `$^`| all dependency (auto remove repeated files)|
| `$?` | dependencies whose time stamp newer than target|

```Makefile
%.o: %.c
  $(CC) -c $< -o $@
```

### Wildcard

```Make
$(wildcard PATTERN)
SRC := $(wildcard *.c)
```

What's more `**/*.c` is not supported in Makefile.
To realize this effect we can use `shell`
`SRC := $(shell find src -name "*.c")`

### shell

`=` and `:=` will lead to different result and have influence on performance.

```Makefile
# This will run everytime when using $(FILES)
FILES = $(shell ls) 

# this will run only the first time
FILES := $(shell ls) 
```

### include

Simple COPY-PASTE , same as include in C.

## EG

The code below is to check whether `$(NEMU_HOME)/src/nemu-main.c` exists.
If it doesn't exist, `wildcard` will return a null string.
And  tow null strings equal, it will throw an error.

```Make
ifeq ($(wildcard $(NEMU_HOME)/src/nemu-main.c),)
  $(error NEMU_HOME=$(NEMU_HOME) is not a NEMU repo)
endif

```

**include files** If I use `include some/files` the relative path depends on
where we run `make run`, in other word the 'root Makefile'

The Eg below , in the child Makefile finds a `.config` file, actually Make will
find this file in the directory where there is a Makefile who includes this

```Make
ifeq ($(wildcard .config),)
```
